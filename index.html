<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ultimate POS Terminali</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --theme-bg: #000000;
            --theme-surface: #1c1c1e;
            --theme-surface-2: #2c2c2e;
            --theme-key: #3a3a3c;
            --theme-primary-text: #ffffff;
            --theme-secondary-text: #8e8e93;
            --theme-blue: #0a84ff;
            --theme-green: #30d158;
            --theme-red: #ff453a;
            --theme-orange: #ff9f0a;
            --theme-border: rgba(120,120,128,0.3);
        }

        html[data-theme='light'] {
            --theme-bg: #f2f2f7;
            --theme-surface: #ffffff;
            --theme-surface-2: #e5e5ea;
            --theme-key: #d1d1d6;
            --theme-primary-text: #000000;
            --theme-secondary-text: #636366;
            --theme-border: rgba(60,60,67,0.2);
        }

        html, body { overscroll-behavior: none; height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: var(--theme-primary-text);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .pos-container {
            height: 100%; display: flex; flex-direction: column;
            background-color: var(--theme-bg);
            box-shadow: 0 0 80px rgba(0,0,0,0.6);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        * { -webkit-tap-highlight-color: transparent; }
        .press-active:active { transform: scale(0.96); filter: brightness(0.85); transition: transform 0.05s ease-out, filter 0.05s ease-out; }

        .view, .overlay-screen, #lock-screen { position: absolute; inset: 0; transition: transform 0.5s, opacity 0.5s; will-change: transform, opacity; }
        .view, #lock-screen { transition-timing-function: cubic-bezier(0.22, 1, 0.36, 1); }
        .view.hidden { opacity: 0; pointer-events: none; transform: scale(0.97); }
        
        #lock-screen { z-index: 200; background-color: var(--theme-bg); }
        #lock-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.05); }

        .overlay-screen {
            z-index: 50; background-color: rgba(18, 18, 18, 0.7);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            opacity: 0; transform: translateY(100%); pointer-events: none;
            transition-timing-function: cubic-bezier(0.22, 1, 0.36, 1);
        }
        html[data-theme='light'] .overlay-screen { background-color: rgba(242, 242, 247, 0.7); }
        .overlay-screen.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }

        .modal-container {
            position: fixed; inset: 0; z-index: 100;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .modal-container.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--theme-surface-2); color: var(--theme-primary-text);
            padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 320px;
            transform: scale(0.95); transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-container.visible .modal-content { transform: scale(1); }

        #bottom-nav { border-top: 1px solid var(--theme-border); background-color: var(--theme-surface); transition: background-color 0.3s ease, border-color 0.3s ease; }
        #bottom-nav button { color: var(--theme-secondary-text); transition: color 0.2s ease; }
        #bottom-nav button.active { color: var(--theme-blue); }

        @keyframes pop-in { 0% { opacity: 0; transform: scale(0.7); } 100% { opacity: 1; transform: scale(1); } }
        .pop-in { animation: pop-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes nfc-wave {
            0% { transform: scale(0.5); opacity: 0.5; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        .nfc-wave-anim { animation: nfc-wave 2s ease-out infinite; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body class="flex items-center justify-center">

    <div class="pos-container w-full max-w-md flex flex-col overflow-hidden relative">
        <div id="lock-screen" class="flex flex-col items-center justify-center cursor-pointer">
             <p id="lock-date" class="text-xl text-theme-secondary-text"></p>
             <h1 id="lock-time" class="text-8xl font-bold my-2"></h1>
             <p class="mt-8 text-theme-blue font-semibold">Kilidi Açmak İçin Dokunun</p>
        </div>

        <div class="px-4 pt-3 flex justify-between items-center text-sm font-medium z-20 text-current">
            <div id="time" class="font-mono"></div>
            <div id="status-icons" class="flex items-center space-x-2"></div>
        </div>

        <main class="flex-grow flex flex-col relative overflow-hidden">
            <div id="home-view" class="view flex flex-col justify-between p-6"></div>
            <div id="keypad-view" class="view hidden flex flex-col"></div>
            <div id="history-view" class="view hidden flex flex-col p-4 pt-0"></div>
            <div id="settings-view" class="view hidden flex flex-col p-4"></div>
        </main>

        <nav id="bottom-nav" class="flex justify-around items-center h-20"></nav>

        <div id="nfc-screen" class="overlay-screen flex flex-col items-center justify-center p-8 text-center"></div>
        <div id="payment-method-screen" class="overlay-screen flex flex-col p-6"></div>
        <div id="loading-screen" class="overlay-screen flex flex-col items-center justify-center p-8"></div>
        <div id="pin-screen" class="overlay-screen flex flex-col items-center justify-center p-4"></div>
        <div id="result-screen" class="overlay-screen flex flex-col items-center justify-center p-8 text-center"></div>
        <div id="receipt-screen" class="overlay-screen flex flex-col items-center justify-center p-8 text-center"></div>
        <div id="transaction-detail-overlay" class="overlay-screen flex flex-col"></div>
        <div id="modal-container"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let state = {
        currentInput: '0',
        pinInput: '',
        activeOverlay: null,
        paymentFlow: {},
        transactions: [],
        settings: {},
        deviceState: 'locked', // locked, active
        idleTimer: null
    };
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const trLocale = 'tr-TR';
    const MAX_INPUT_LENGTH = 7;
    const MAX_PIN_LENGTH = 4;
    const CONTACTLESS_LIMIT = 750;
    const defaultSettings = {
        theme: 'dark',
        merchantName: 'Kahve Dükkanı',
        quickSaleAmounts: [85, 120, 150],
        sound: true,
        haptics: true
    };
    
    const DOMElements = {};
    ['body', 'lock-screen', 'lock-date', 'lock-time', 'time', 'status-icons', 'home-view', 'keypad-view', 'history-view', 'settings-view',
     'bottom-nav', 'main-content', 'modal-container']
    .forEach(id => DOMElements[id] = document.getElementById(id));
    document.querySelectorAll('.overlay-screen').forEach(el => DOMElements[el.id] = el);

    const formatCurrency = (value) => new Intl.NumberFormat(trLocale, { style: 'currency', currency: 'TRY' }).format(value);
    const formatDate = (date, options) => new Date(date).toLocaleString(trLocale, options);
    const generateId = () => Math.random().toString(36).substring(2, 10).toUpperCase();

    const playSound = (type) => {
        if (!state.settings.sound || !audioCtx) return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        g.gain.setValueAtTime(0, audioCtx.currentTime);
        const sounds = {
            tap: { f: 800, g: 0.1, d: 0.05, t: 'triangle' }, tapLight: { f: 1200, g: 0.08, d: 0.04, t: 'triangle' },
            success: { f: 700, g: 0.3, d: 0.2, t: 'sine' }, finalSuccess: { f: 900, g: 0.4, d: 0.3, t: 'sine' },
            error: { f: 200, g: 0.3, d: 0.2, t: 'sine' }, cancel: { f: 400, g: 0.2, d: 0.1, t: 'sine' },
        };
        const s = sounds[type];
        o.type = s.t; o.frequency.setValueAtTime(s.f, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(s.g, audioCtx.currentTime + 0.01);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + s.d);
        o.start(); o.stop(audioCtx.currentTime + s.d);
    };
    const doHapticFeedback = (intensity = 'light') => {
        if (state.settings.haptics && navigator.vibrate) {
            const vibrations = { light: 10, medium: 30, heavy: 50 };
            navigator.vibrate(vibrations[intensity]);
        }
    };
    
    const resetIdleTimer = () => {
        if (state.deviceState !== 'active') return;
        clearTimeout(state.idleTimer);
        state.idleTimer = setTimeout(goToLockScreen, 30000); // 30 saniye
    };
    const goToLockScreen = () => {
        state.deviceState = 'locked';
        DOMElements['lock-screen'].classList.remove('hidden');
        closeAllOverlays();
        navigateTo('home-view');
        clearTimeout(state.idleTimer);
    };
    const unlockDevice = () => {
        state.deviceState = 'active';
        DOMElements['lock-screen'].classList.add('hidden');
        resetIdleTimer();
    };

    const saveSettings = () => localStorage.setItem('posSettingsV2', JSON.stringify(state.settings));
    const loadSettings = () => {
        const saved = localStorage.getItem('posSettingsV2');
        state.settings = saved ? { ...defaultSettings, ...JSON.parse(saved) } : { ...defaultSettings };
        applyTheme();
    };
    const saveTransactions = () => localStorage.setItem('posTransactionsV2', JSON.stringify(state.transactions));
    const loadTransactions = () => {
        const saved = localStorage.getItem('posTransactionsV2');
        state.transactions = saved ? JSON.parse(saved).map(t => ({...t, date: new Date(t.date)})) : [];
    };
    const resetAllData = () => {
        showModal(`
            <h3 class="text-lg font-bold text-center mb-2">Tüm Verileri Sıfırla</h3>
            <p class="text-center text-theme-secondary-text mb-6">Tüm işlem geçmişi ve ayarlar kalıcı olarak silinecektir. Bu işlem geri alınamaz.</p>
            <div class="flex space-x-3">
                <button onclick="window.closeModal()" class="flex-1 h-12 bg-theme-key rounded-lg">Vazgeç</button>
                <button id="confirm-reset" class="flex-1 h-12 bg-theme-red text-white rounded-lg">Sıfırla</button>
            </div>
        `);
        document.getElementById('confirm-reset').onclick = () => {
            localStorage.removeItem('posSettingsV2');
            localStorage.removeItem('posTransactionsV2');
            loadSettings();
            loadTransactions();
            renderAllViews();
            navigateTo('settings-view');
            closeModal();
        };
    };
    const applyTheme = () => document.documentElement.dataset.theme = state.settings.theme;

    const navigateTo = (tabId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        DOMElements[tabId].classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-btn[data-tab='${tabId}']`).classList.add('active');
        if (tabId === 'history-view') renderHistoryView();
        if (tabId === 'settings-view') renderSettingsView();
        if (tabId === 'home-view') renderHomeView();
    };

    const switchView = (viewId) => {
        if(viewId === 'keypad') {
            DOMElements['home-view'].classList.add('hidden');
            DOMElements['keypad-view'].classList.remove('hidden');
        } else {
            DOMElements['keypad-view'].classList.add('hidden');
            DOMElements['home-view'].classList.remove('hidden');
        }
    };
    
    const showModal = (contentHTML) => {
        DOMElements['modal-container'].innerHTML = `<div class="modal-backdrop absolute inset-0"></div><div class="modal-content relative pop-in">${contentHTML}</div>`;
        DOMElements['modal-container'].classList.add('visible');
        DOMElements['modal-container'].querySelector('.modal-backdrop').onclick = closeModal;
    };
    const closeModal = () => DOMElements['modal-container'].classList.remove('visible');

    const showOverlay = (screenId) => {
        if (state.activeOverlay) DOMElements[state.activeOverlay].classList.remove('visible');
        DOMElements[screenId].classList.add('visible');
        state.activeOverlay = screenId;
    };
    const closeAllOverlays = () => {
        document.querySelectorAll('.overlay-screen.visible').forEach(s => s.classList.remove('visible'));
        state.activeOverlay = null;
    };

    const renderHomeView = () => {
        DOMElements['home-view'].innerHTML = `
            <div class="text-center pt-16">
                <h1 class="text-4xl font-bold">${state.settings.merchantName}</h1>
                <p class="text-lg text-theme-secondary-text mt-1">POS Terminali v4.0</p>
            </div>
            <div class="w-full">
                <p class="text-sm font-medium text-theme-secondary-text mb-3 text-center">HIZLI SATIŞ</p>
                <div class="grid grid-cols-3 gap-3 mb-6">
                    ${state.settings.quickSaleAmounts.map(amount => `
                        <button data-amount="${amount}" class="quick-sale-btn press-active h-20 bg-theme-surface rounded-xl text-2xl font-semibold">${formatCurrency(amount)}</button>
                    `).join('')}
                </div>
                <button id="show-keypad-btn" class="press-active w-full h-20 bg-theme-blue rounded-2xl text-3xl font-bold text-white">Tutar Gir</button>
            </div>`;
        DOMElements['home-view'].querySelector('#show-keypad-btn').onclick = () => switchView('keypad');
        DOMElements['home-view'].querySelectorAll('.quick-sale-btn').forEach(btn => {
            btn.onclick = () => startPaymentFlow(btn.dataset.amount);
        });
    };

    const renderKeypadView = () => {
        const mainKeys = ['1', '2', '3', '⌫', '4', '5', '6', 'Geri', '7', '8', '9', 'Öde', '00', '0', ','];
        DOMElements['keypad-view'].innerHTML = `
            <div class="text-right px-6 pb-4 flex-grow flex flex-col justify-end">
                <div id="display" class="text-theme-primary-text text-8xl font-thin break-words select-none" style="min-height: 100px;"></div>
            </div>
            <div id="main-keypad" class="grid grid-cols-4 gap-3 p-4"></div>`;
        
        const keypadContainer = DOMElements['keypad-view'].querySelector('#main-keypad');
        mainKeys.forEach(key => {
            const button = document.createElement('button');
            button.textContent = key;
            button.dataset.key = key;
            let classes = 'key press-active rounded-2xl text-3xl font-medium flex justify-center items-center h-20 ';
            switch(key) {
                case '⌫': classes += 'bg-theme-surface-2 text-theme-orange'; button.dataset.action = 'backspace'; break;
                case 'Geri': classes += 'bg-theme-surface-2 text-theme-red'; button.dataset.action = 'clear'; break;
                case 'Öde': classes += 'bg-theme-green col-span-2 text-white font-bold'; button.dataset.action = 'charge'; break;
                default: classes += 'bg-theme-key'; button.dataset.action = 'input';
            }
            button.className = classes;
            keypadContainer.appendChild(button);
        });
        keypadContainer.addEventListener('click', e => {
            const target = e.target.closest('.key');
            if(target) handleKeyInput(target.dataset.key, target.dataset.action);
        });
    };
    
    const renderHistoryView = (filter = 'all') => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const todaysTransactions = state.transactions.filter(t => new Date(t.date) >= today && t.status === 'Onaylandı');
        const totalSales = todaysTransactions.reduce((sum, t) => sum + t.amount, 0);
        const transactionCount = todaysTransactions.length;
        const averageSale = transactionCount > 0 ? totalSales / transactionCount : 0;

        const filtered = state.transactions.filter(t => {
            if (filter === 'sale') return t.status === 'Onaylandı';
            if (filter === 'refund') return t.status === 'İade Edildi';
            return true;
        }).sort((a, b) => new Date(b.date) - new Date(a.date));

        DOMElements['history-view'].innerHTML = `
            <div class="p-4 pt-6 bg-theme-surface">
                <h1 class="text-3xl font-bold mb-4">Genel Bakış</h1>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-theme-surface-2 p-3 rounded-xl">
                        <p class="text-sm text-theme-secondary-text">Bugünkü Satış</p>
                        <p class="font-bold text-lg text-theme-green">${formatCurrency(totalSales)}</p>
                    </div>
                    <div class="bg-theme-surface-2 p-3 rounded-xl">
                        <p class="text-sm text-theme-secondary-text">İşlem Sayısı</p>
                        <p class="font-bold text-lg">${transactionCount}</p>
                    </div>
                    <div class="bg-theme-surface-2 p-3 rounded-xl">
                        <p class="text-sm text-theme-secondary-text">Ort. İşlem</p>
                        <p class="font-bold text-lg">${formatCurrency(averageSale)}</p>
                    </div>
                </div>
                 <div class="flex items-center justify-center space-x-2 mt-4 p-1 bg-theme-surface-2 rounded-lg">
                    <button data-filter="all" class="history-filter flex-1 py-1 rounded-md text-sm ${filter === 'all' ? 'bg-theme-blue text-white' : ''}">Tümü</button>
                    <button data-filter="sale" class="history-filter flex-1 py-1 rounded-md text-sm ${filter === 'sale' ? 'bg-theme-blue text-white' : ''}">Satış</button>
                    <button data-filter="refund" class="history-filter flex-1 py-1 rounded-md text-sm ${filter === 'refund' ? 'bg-theme-blue text-white' : ''}">İade</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto space-y-2 p-4">
                ${filtered.length === 0 ? `<p class="text-center text-theme-secondary-text mt-8">Henüz işlem yok.</p>` :
                filtered.map(t => `
                    <div data-id="${t.id}" class="transaction-item press-active p-4 bg-theme-surface rounded-lg flex justify-between items-center cursor-pointer">
                        <div>
                            <p class="font-semibold text-lg">${t.method || 'Kart'}</p>
                            <p class="text-sm text-theme-secondary-text">${formatDate(t.date, { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg ${t.status === 'Onaylandı' ? 'text-theme-green' : 'text-theme-red'}">${t.status === 'İade Edildi' ? '-' : ''}${t.formattedAmount}</p>
                            <p class="text-sm text-theme-secondary-text">${t.status}</p>
                        </div>
                    </div>`).join('')}
            </div>`;
        DOMElements['history-view'].querySelectorAll('.transaction-item').forEach(item => {
            item.onclick = () => showTransactionDetail(item.dataset.id);
        });
        DOMElements['history-view'].querySelectorAll('.history-filter').forEach(btn => {
            btn.onclick = () => renderHistoryView(btn.dataset.filter);
        });
    };

    const renderSettingsView = () => {
        DOMElements['settings-view'].innerHTML = `
            <h1 class="text-3xl font-bold mb-6 px-2">Ayarlar</h1>
            <div class="flex-grow overflow-y-auto space-y-6">
                <!-- Genel Ayarlar -->
                <div class="space-y-2">
                    <h2 class="text-lg font-semibold text-theme-secondary-text px-4">Genel</h2>
                    <div class="bg-theme-surface rounded-xl p-4 space-y-4">
                        <div>
                            <label for="merchant-name" class="text-sm text-theme-secondary-text">İşletme Adı</label>
                            <input type="text" id="merchant-name" value="${state.settings.merchantName}" class="w-full bg-transparent border-b border-theme-border focus:border-theme-blue outline-none py-1 text-lg text-theme-primary-text">
                        </div>
                        <div>
                             <label class="text-sm text-theme-secondary-text">Tema</label>
                             <div class="flex space-x-2 mt-1">
                                <button data-theme="dark" class="theme-btn flex-1 py-2 rounded-lg ${state.settings.theme === 'dark' ? 'bg-theme-blue text-white' : 'bg-theme-key'}">Koyu</button>
                                <button data-theme="light" class="theme-btn flex-1 py-2 rounded-lg ${state.settings.theme === 'light' ? 'bg-theme-blue text-white' : 'bg-theme-key'}">Açık</button>
                             </div>
                        </div>
                    </div>
                </div>
                <!-- Hızlı Satış -->
                <div class="space-y-2">
                    <h2 class="text-lg font-semibold text-theme-secondary-text px-4">Hızlı Satış Butonları</h2>
                    <div class="bg-theme-surface rounded-xl p-4 grid grid-cols-3 gap-4">
                        ${state.settings.quickSaleAmounts.map((val, i) => `
                            <div>
                                <label for="qs-${i}" class="text-xs text-theme-secondary-text">Buton ${i + 1}</label>
                                <input type="number" id="qs-${i}" data-index="${i}" value="${val}" class="quick-sale-input w-full bg-transparent border-b border-theme-border focus:border-theme-blue outline-none py-1 text-lg text-center text-theme-primary-text">
                            </div>`).join('')}
                    </div>
                </div>
                 <!-- Veri -->
                <div class="space-y-2">
                    <h2 class="text-lg font-semibold text-theme-secondary-text px-4">Veri Yönetimi</h2>
                    <div class="bg-theme-surface rounded-xl">
                       <button id="reset-data-btn" class="w-full p-4 text-theme-red text-center">Ayarları ve İşlemleri Sıfırla</button>
                    </div>
                </div>
            </div>`;
        DOMElements['settings-view'].querySelector('#merchant-name').onblur = e => { state.settings.merchantName = e.target.value; saveSettings(); renderHomeView(); };
        DOMElements['settings-view'].querySelectorAll('.theme-btn').forEach(btn => {
            btn.onclick = e => { state.settings.theme = e.target.dataset.theme; saveSettings(); applyTheme(); renderSettingsView(); };
        });
        DOMElements['settings-view'].querySelectorAll('.quick-sale-input').forEach(input => {
            input.onblur = e => { state.settings.quickSaleAmounts[e.target.dataset.index] = Number(e.target.value); saveSettings(); };
        });
        DOMElements['settings-view'].querySelector('#reset-data-btn').onclick = resetAllData;
    };
    
    const startPaymentFlow = (amount) => {
        const numericAmount = parseFloat(String(amount).replace(',', '.'));
        if (isNaN(numericAmount) || numericAmount <= 0) {
            playSound('error'); return;
        }
        state.paymentFlow = {
            amount: numericAmount,
            formattedAmount: formatCurrency(numericAmount),
            date: new Date(),
        };
        renderNfcScreen();
        showOverlay('nfc-screen');
    };

    const cancelPaymentFlow = () => {
        playSound('cancel'); doHapticFeedback('medium');
        closeAllOverlays();
        state.paymentFlow = {}; state.pinInput = '';
    };

    const handleKeyInput = (key, action) => {
        doHapticFeedback(); playSound('tap');
        
        if (action === 'input') {
            if (key === ',' && state.currentInput.includes(',')) return;
            if (state.currentInput.replace(/[.,]/g, '').length >= MAX_INPUT_LENGTH) return;
            if (state.currentInput === '0') {
                state.currentInput = (key === ',') ? '0,' : key;
            } else {
                state.currentInput += key;
            }
        } else if (action === 'backspace') {
            state.currentInput = state.currentInput.length > 1 ? state.currentInput.slice(0, -1) : '0';
        } else if (action === 'clear') { // Geri butonu
            if (state.currentInput === '0') { switchView('home'); } 
            else { state.currentInput = '0'; }
        } else if (action === 'charge') {
            startPaymentFlow(state.currentInput);
        }
        updateDisplay();
    };

    const updateDisplay = () => {
        const displayEl = DOMElements['keypad-view'].querySelector('#display');
        const value = parseFloat(state.currentInput.replace(',', '.'));
        if (isNaN(value) || value === 0) {
            displayEl.textContent = ''; return;
        }
        displayEl.textContent = formatCurrency(value);
        const len = displayEl.textContent.length;
        displayEl.className = 'text-theme-primary-text font-thin break-words select-none ' + 
            (len > 12 ? 'text-6xl' : len > 9 ? 'text-7xl' : 'text-8xl');
    };
    
    const renderNfcScreen = () => {
        DOMElements['nfc-screen'].innerHTML = `
            <p class="text-5xl font-bold mb-4 text-theme-primary-text">${state.paymentFlow.formattedAmount}</p>
            <p class="text-2xl text-theme-secondary-text font-medium mb-12">Kartınızı Okutun</p>
            <div class="relative w-64 h-64 flex items-center justify-center">
                <div class="absolute w-24 h-24 bg-theme-blue rounded-full nfc-wave-anim" style="animation-delay: 0s;"></div>
                <div class="absolute w-24 h-24 bg-theme-blue rounded-full nfc-wave-anim" style="animation-delay: 1s;"></div>
                <svg class="w-24 h-24 text-white z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            </div>
            <button onclick="window.cancelPaymentFlow()" class="absolute bottom-8 text-lg text-theme-blue font-semibold">İptal</button>`;
        
        setTimeout(() => {
            if (state.activeOverlay !== 'nfc-screen') return;
            playSound('success'); doHapticFeedback('medium');
            renderLoadingScreen('İşleniyor...'); showOverlay('loading-screen');
            setTimeout(() => {
                if(state.paymentFlow.amount < CONTACTLESS_LIMIT) {
                    authorizePayment();
                } else {
                    renderPinScreen(); showOverlay('pin-screen');
                }
            }, 1500);
        }, 2000);
    };

    const renderPinScreen = (isRefund = false, transactionId = null) => {
        state.pinInput = '';
        DOMElements['pin-screen'].innerHTML = `
            <div class="flex-grow flex flex-col items-center justify-center text-theme-primary-text">
                <h1 class="text-2xl font-semibold mb-4">${isRefund ? 'İade için Şifre Girin' : 'Kart Şifrenizi Girin'}</h1>
                <div id="pin-dots" class="flex space-x-4 my-6">${Array(MAX_PIN_LENGTH).fill('<span></span>').join('')}</div>
            </div>
            <div id="pin-keypad" class="grid grid-cols-3 gap-3 p-4 w-full max-w-sm"></div>`;
        
        const pinKeypad = DOMElements['pin-screen'].querySelector('#pin-keypad');
        ['1','2','3','4','5','6','7','8','9','İptal','0','⌫'].forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'key press-active rounded-full text-3xl font-medium flex justify-center items-center bg-transparent text-theme-primary-text h-20';
            btn.textContent = key;
            if (key === 'İptal') { btn.className += ' text-base text-theme-blue font-semibold'; btn.onclick = cancelPaymentFlow; } 
            else { btn.dataset.key = key; }
            pinKeypad.appendChild(btn);
        });
        pinKeypad.addEventListener('click', e => {
            const key = e.target.closest('.key')?.dataset.key;
            if(key) handlePinInput(key, isRefund, transactionId);
        });
    };

    const handlePinInput = (key, isRefund, transactionId) => {
        playSound('tapLight'); doHapticFeedback();
        if (key === '⌫') state.pinInput = state.pinInput.slice(0, -1);
        else if (state.pinInput.length < MAX_PIN_LENGTH) state.pinInput += key;
        
        DOMElements['pin-screen'].querySelectorAll('#pin-dots span').forEach((d, i) => d.classList.toggle('active', i < state.pinInput.length));
        
        if (state.pinInput.length === MAX_PIN_LENGTH) authorizePayment(isRefund, transactionId);
    };

    const authorizePayment = (isRefund = false, transactionId = null) => {
        renderLoadingScreen('Yetkilendiriliyor...'); showOverlay('loading-screen');
        setTimeout(() => {
            const isSuccess = Math.random() > 0.15;
            if (isRefund) { processRefund(transactionId, isSuccess); } 
            else { finalizeTransaction(isSuccess); }
        }, 2000);
    };

    const finalizeTransaction = (isSuccess) => {
        if (isSuccess) {
            state.paymentFlow.id = generateId();
            state.paymentFlow.status = 'Onaylandı';
            state.paymentFlow.cardType = Math.random() > 0.5 ? 'Mastercard' : 'Visa';
            state.paymentFlow.bank = 'AKBANK';
            state.paymentFlow.installments = 'Tek Çekim';
            state.transactions.unshift(state.paymentFlow);
            saveTransactions();
        }
        renderResultScreen(isSuccess);
        showOverlay('result-screen');
    };
    
    const showTransactionDetail = (id) => {
        const t = state.transactions.find(tx => tx.id === id);
        if (!t) return;
        DOMElements['transaction-detail-overlay'].innerHTML = `
            <div class="p-4 bg-theme-surface flex justify-between items-center">
                <h2 class="text-xl font-bold">İşlem Detayı</h2>
                <button onclick="window.closeAllOverlays()" class="text-theme-blue font-semibold">Bitti</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <div class="text-center mb-8">
                    <p class="text-6xl font-bold ${t.status === 'Onaylandı' ? 'text-theme-green' : 'text-theme-red'}">${t.status === 'İade Edildi' ? '-' : ''}${t.formattedAmount}</p>
                    <p class="font-semibold text-lg ${t.status === 'Onaylandı' ? 'text-theme-green' : 'text-theme-red'}">${t.status}</p>
                </div>
                <div class="space-y-3 bg-theme-surface-2 rounded-xl p-4">
                    <div class="flex justify-between"><span>Tarih:</span><span class="font-medium">${formatDate(t.date, {dateStyle: 'full', timeStyle: 'short'})}</span></div>
                    <div class="flex justify-between"><span>Banka:</span><span class="font-medium">${t.bank}</span></div>
                    <div class="flex justify-between"><span>Kart:</span><span class="font-medium">**** **** **** ${Math.floor(1000 + Math.random() * 9000)} (${t.cardType})</span></div>
                    <div class="flex justify-between"><span>Taksit:</span><span class="font-medium">${t.installments}</span></div>
                    <div class="flex justify-between"><span>İşlem ID:</span><span class="font-mono text-sm">${t.id}</span></div>
                </div>
                ${t.status === 'Onaylandı' ? `
                    <button id="refund-btn" data-id="${t.id}" class="mt-8 w-full h-14 bg-theme-red text-white rounded-xl text-xl font-bold press-active">Bu İşlemi İade Et</button>
                ` : ''}
            </div>`;
        if (t.status === 'Onaylandı') {
            DOMElements['transaction-detail-overlay'].querySelector('#refund-btn').onclick = e => startRefundFlow(e.target.dataset.id);
        }
        showOverlay('transaction-detail-overlay');
    };

    const startRefundFlow = (id) => {
        const t = state.transactions.find(tx => tx.id === id);
        showModal(`
            <h3 class="text-lg font-bold text-center mb-2">İade Onayı</h3>
            <p class="text-center text-theme-secondary-text mb-6">${t.formattedAmount} tutarındaki işlemi iade etmek istediğinizden emin misiniz?</p>
            <div class="flex space-x-3">
                <button onclick="window.closeModal()" class="flex-1 h-12 bg-theme-key rounded-lg">Vazgeç</button>
                <button id="confirm-refund" class="flex-1 h-12 bg-theme-red text-white rounded-lg">Onayla</button>
            </div>
        `);
        document.getElementById('confirm-refund').onclick = () => {
            closeModal();
            state.paymentFlow = t;
            renderPinScreen(true, id);
            showOverlay('pin-screen');
        };
    };

    const processRefund = (id, isSuccess) => {
        if(isSuccess) {
            const index = state.transactions.findIndex(tx => tx.id === id);
            if(index !== -1) {
                state.transactions[index].status = 'İade Edildi';
                saveTransactions();
            }
        }
        renderResultScreen(isSuccess, true);
        showOverlay('result-screen');
    };

    const renderResultScreen = (isSuccess, isRefund = false) => {
        const successIcon = `<svg class="h-full w-full text-theme-green" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        const errorIcon = `<svg class="h-full w-full text-theme-red" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        let title = '', subtitle = '';
        if(isRefund) {
            title = isSuccess ? 'İade Başarılı' : 'İade Başarısız';
            subtitle = isSuccess ? 'İşlem başarıyla iade edildi.' : 'İade işlemi gerçekleştirilemedi.';
        } else {
            title = isSuccess ? 'Onaylandı' : 'Reddedildi';
            subtitle = isSuccess ? 'Ödeme başarıyla alındı.' : 'Lütfen başka bir kart deneyin.';
        }
        DOMElements['result-screen'].innerHTML = `<div class="h-28 w-28 mb-6 pop-in">${isSuccess ? successIcon : errorIcon}</div><h2 class="text-4xl font-bold mb-2">${title}</h2><p class="text-lg text-theme-secondary-text">${subtitle}</p>`;
        playSound(isSuccess ? 'finalSuccess' : 'error');
        doHapticFeedback('heavy');

        setTimeout(() => {
            if (isSuccess && !isRefund) {
                renderReceiptScreen(); showOverlay('receipt-screen');
            } else {
                cancelPaymentFlow(); state.currentInput = '0';
                updateDisplay(); navigateTo('home-view');
            }
        }, isSuccess ? 2000 : 2500);
    };

    const renderReceiptScreen = () => {
        DOMElements['receipt-screen'].innerHTML = `
            <h2 class="text-3xl font-bold mb-12">Fiş ister misiniz?</h2>
            <div class="w-full max-w-xs space-y-4">
                 <button id="print-receipt" class="list-item press-active w-full p-5 bg-theme-surface rounded-xl text-xl font-semibold">Fiş Yazdır</button>
                 <button id="sms-receipt" class="list-item press-active w-full p-5 bg-theme-surface rounded-xl text-xl font-semibold">SMS Gönder</button>
                 <button id="no-receipt" class="mt-8 text-theme-secondary-text">Fiş İstemiyorum</button>
            </div>`;
        const reset = () => {
            playSound('tapLight'); cancelPaymentFlow();
            state.currentInput = '0'; updateDisplay(); navigateTo('home-view');
        };
        document.getElementById('print-receipt').onclick = () => { renderLoadingScreen('Fiş yazdırılıyor...'); showOverlay('loading-screen'); setTimeout(reset, 1500); };
        document.getElementById('sms-receipt').onclick = () => { renderLoadingScreen('SMS gönderiliyor...'); showOverlay('loading-screen'); setTimeout(reset, 1500); };
        document.getElementById('no-receipt').onclick = reset;
    };
    
    const renderLoadingScreen = (text) => {
        DOMElements['loading-screen'].innerHTML = `<div class="spinner w-16 h-16 rounded-full border-4 border-theme-key border-t-theme-primary-text"></div><p class="mt-6 text-xl text-theme-secondary-text">${text}</p>`;
    };

    const init = () => {
        loadSettings();
        loadTransactions();
        
        window.cancelPaymentFlow = cancelPaymentFlow;
        window.closeAllOverlays = closeAllOverlays;
        window.closeModal = closeModal;

        const updateClocks = () => { 
            const now = new Date();
            DOMElements.time.textContent = formatDate(now, { hour: '2-digit', minute: '2-digit' }); 
            DOMElements['lock-time'].textContent = formatDate(now, { hour: '2-digit', minute: '2-digit' }); 
            DOMElements['lock-date'].textContent = formatDate(now, { weekday: 'long', day: 'numeric', month: 'long' }); 
        };
        updateClocks(); setInterval(updateClocks, 1000);
        
        DOMElements['status-icons'].innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.778 8.222c-4.296-4.296-11.26-4.296-15.556 0A1 1 0 01.808 6.808c5.076-5.077 13.308-5.077 18.384 0a1 1 0 01-1.414 1.414zM16.364 9.636c-3.536-3.536-9.26-3.536-12.728 0a1 1 0 01-1.414-1.414c4.314-4.314 11.31-4.314 15.556 0a1 1 0 11-1.414 1.414z" clip-rule="evenodd" /><path d="M14.242 11.758a1 1 0 01-1.414 0c-2.402-2.402-6.28-2.402-8.682 0a1 1 0 11-1.414-1.414c3.18-3.18 8.322-3.18 11.502 0a1 1 0 010 1.414zM12 14a1 1 0 11-2 0 1 1 0 012 0z" /></svg><div class="flex items-center"><span>100%</span><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20h6a2 2 0 002-2V6a2 2 0 00-2-2H9a2 2 0 00-2 2v12a2 2 0 002 2z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.5 9.5h-1.5" transform="rotate(90 18 10)" /></svg></div>`;
        DOMElements['bottom-nav'].innerHTML = `
            <button data-tab="home-view" class="nav-btn press-active flex flex-col items-center justify-center w-full h-full">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
                <span class="text-xs mt-1">Ana Sayfa</span>
            </button>
            <button data-tab="history-view" class="nav-btn press-active flex flex-col items-center justify-center w-full h-full">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                <span class="text-xs mt-1">Geçmiş</span>
            </button>
            <button data-tab="settings-view" class="nav-btn press-active flex flex-col items-center justify-center w-full h-full">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 00-2 0v2.28a1 1 0 00.9 1l.882.22c.16.04.3.14.4.28l.42.56a1 1 0 001.58-.3l.42-.56a1 1 0 011.58 0l.42.56a1 1 0 001.58.3l.42-.56c.1-.14.24-.24.4-.28l.882-.22a1 1 0 00.9-1V4a1 1 0 00-2 0v1.59a1 1 0 00-.9.99l-.882.22a1 1 0 01-.79-.14l-.42-.56a1 1 0 00-1.58 0l-.42.56a1 1 0 01-.79.14l-.882-.22a1 1 0 00-.9-.99V4zM17 9.28a1 1 0 00-1 1V14a1 1 0 002 0v-2.28a1 1 0 00-.9-1l-.882-.22a1 1 0 01-.79.14l-.42.56a1 1 0 00-1.58 0l-.42-.56a1 1 0 01-1.58 0l-.42.56a1 1 0 00-1.58 0l-.42-.56a1 1 0 01-.79-.14l-.882-.22a1 1 0 00-.9.99V14a1 1 0 002 0v-1.59a1 1 0 00.9-.99l.882-.22c.16-.04.3-.14.4-.28l.42-.56a1 1 0 001.58.3l.42.56a1 1 0 011.58 0l.42.56c.1.14.24.24.4.28l.882.22a1 1 0 00.9 1V10a1 1 0 00-1-1z"/></svg>
                <span class="text-xs mt-1">Ayarlar</span>
            </button>
        `;

        DOMElements['lock-screen'].onclick = unlockDevice;
        document.body.addEventListener('click', resetIdleTimer, true);
        document.body.addEventListener('touchstart', resetIdleTimer, true);
        
        renderAllViews();
        goToLockScreen();
        
        DOMElements['bottom-nav'].querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => navigateTo(btn.dataset.tab);
        });
    };
    
    const renderAllViews = () => {
        renderHomeView();
        renderKeypadView();
        renderHistoryView();
        renderSettingsView();
    };
    
    init();
});
</script>
</body>
</html>
